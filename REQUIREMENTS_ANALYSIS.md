# 要件分析：現在のアプリに取り込めそうな要件の整理

## 📋 現在のアプリの状態

### 既存機能

- ✅ 都道府県マップ（SVG）の表示
- ✅ 都道府県データ（47都道府県、id/name/region/slug）
- ✅ マップクリックで都道府県情報取得
- ✅ レスポンシブ対応（画面サイズに収まる）

### 技術スタック

- React 19 + TypeScript
- Vite（ビルドツール）
- React Router（ルーティング）
- TanStack Query（データフェッチング）
- Radix UI（UIコンポーネント）
- Tailwind CSS（スタイリング）
- Orval（APIコード生成）
- Axios（HTTPクライアント）

---

## 🎯 取り込めそうな要件の整理

### 【優先度：高】既存基盤を活用できる要件

#### 1. **都道府県ベースのナビゲーション・表示**

**現状との適合度：⭐⭐⭐⭐⭐（完全に活用可能）**

- ✅ **既存**: 都道府県マップ、都道府県データ（id/name/region/slug）
- 🎯 **要件**: 県別のアイテム一覧、県ボード、県選択UI
- **活用方法**:
  - マップクリック → 県ボード画面への遷移
  - 県一覧画面（グループホーム）でマップを活用
  - 都道府県データをそのまま使用（拡張は必要：市データ追加）

**実装イメージ**:

```
マップクリック → 県ボード（アイテム一覧）
県一覧画面 → マップ表示 + 件数表示
```

---

#### 2. **データ構造の拡張**

**現状との適合度：⭐⭐⭐⭐（拡張が必要）**

- ✅ **既存**: `Prefecture`型（id, name, region, slug）
- 🎯 **要件**: 市データ、アイテム、履歴、グループ等の型定義
- **必要な拡張**:
  - `Prefecture`型に`cities`配列を追加（任意）
  - 新規型定義：`Item`, `VisitRecord`, `Group`, `NationwideItem`, `MediaAttachment`

**実装イメージ**:

```typescript
// 拡張例
export type Prefecture = {
  id: number
  name: string
  region: string
  slug: string
  cities?: City[] // 追加
}

export type City = {
  id: number
  name: string
  prefectureId: number
}
```

---

#### 3. **ルーティング基盤**

**現状との適合度：⭐⭐⭐⭐⭐（既に設定済み）**

- ✅ **既存**: React Router設定済み
- 🎯 **要件**: グループ選択、県ボード、アイテム詳細、全国TODO等の画面遷移
- **活用方法**:
  - 既存のルーティング設定を拡張
  - 画面構成に合わせてルートを追加

**必要な画面**:

- `/groups` - グループ一覧/選択
- `/groups/:groupId` - グループホーム（県一覧）
- `/groups/:groupId/prefectures/:prefectureId` - 県ボード
- `/groups/:groupId/items/:itemId` - アイテム詳細
- `/groups/:groupId/nationwide` - 全国TODO
- `/groups/:groupId/history` - 履歴ギャラリー

---

#### 4. **APIクライアント基盤**

**現状との適合度：⭐⭐⭐⭐⭐（既に設定済み）**

- ✅ **既存**: Axios + 認証インターセプター、Orval設定
- 🎯 **要件**: グループ、アイテム、履歴等のAPI呼び出し
- **活用方法**:
  - 既存の`customInstance`をそのまま使用
  - OrvalでAPI型定義を自動生成
  - TanStack Queryでデータフェッチング

**必要なAPI**:

- グループ管理（作成/参加/取得）
- アイテム管理（CRUD）
- 履歴管理（CRUD）
- 全国TODO管理
- メディア埋め込み情報取得

---

#### 5. **UIコンポーネント基盤**

**現状との適合度：⭐⭐⭐⭐（拡張が必要）**

- ✅ **既存**: Radix UI（Dialog, Dropdown, Select, Toast, Tooltip）
- 🎯 **要件**: モーダル、フォーム、カード表示、フィルタUI等
- **活用方法**:
  - Radix UIのコンポーネントを組み合わせて実装
  - カスタムコンポーネントを作成

**必要なUIコンポーネント**:

- アイテム登録モーダル（Dialog使用）
- フィルタUI（Select, Dropdown使用）
- カード表示（サムネ + 情報）
- トースト通知（Toast使用）
- ローディング表示

---

### 【優先度：中】新規実装が必要だが、基盤は活用できる要件

#### 6. **メディア埋め込み機能（Instagram中心）**

**現状との適合度：⭐⭐⭐（新規実装が必要）**

- ❌ **既存**: なし
- 🎯 **要件**: Instagram URLの3段階表示（埋め込み/カード/リンク）
- **実装方針**:
  - Instagram埋め込みAPI（oEmbed）を使用
  - フォールバック処理（埋め込み不可 → カード → リンク）
  - サムネイル取得と表示

**必要な機能**:

- URL検証（Instagram形式チェック）
- oEmbed API呼び出し
- 埋め込みHTMLの安全な表示（XSS対策）
- カード情報取得（OGP等）
- エラーハンドリング

---

#### 7. **検索・フィルタ機能**

**現状との適合度：⭐⭐⭐（新規実装が必要）**

- ❌ **既存**: なし
- 🎯 **要件**: キーワード検索、県/市/タグ/ステータスでフィルタ
- **実装方針**:
  - クライアント側フィルタリング（小規模データ想定）
  - サーバー側検索（大規模データ時）

**必要な機能**:

- 検索入力UI
- フィルタUI（複数条件組み合わせ）
- 検索結果のハイライト表示

---

#### 8. **ステータス管理（行った/行ってない/また行きたい）**

**現状との適合度：⭐⭐⭐（新規実装が必要）**

- ❌ **既存**: なし
- 🎯 **要件**: ステータス切替、履歴作成、再訪フラグ
- **実装方針**:
  - ステータスはenum型で管理
  - ステータス変更時に履歴作成モーダル表示
  - UIで視覚的に区別（バッジ、色分け等）

**必要な機能**:

- ステータス切替UI
- 履歴作成フォーム
- ステータス別フィルタ

---

### 【優先度：低】完全新規実装が必要な要件

#### 9. **グループ管理機能**

**現状との適合度：⭐⭐（基盤のみ活用可能）**

- ❌ **既存**: なし
- 🎯 **要件**: グループ作成、招待リンク、参加/退出
- **実装方針**:
  - 招待リンクはランダムトークン生成
  - グループIDをURLに含める（`/groups/:groupId`）
  - ローカルストレージで参加グループを管理（MVP）

**必要な機能**:

- グループ作成フォーム
- 招待リンク生成・表示
- 参加処理（トークン検証）
- グループ一覧表示

---

#### 10. **タグ機能**

**現状との適合度：⭐⭐（新規実装が必要）**

- ❌ **既存**: なし
- 🎯 **要件**: 固定タグ（飯/カフェ/観光/体験/宿等）の付与・フィルタ
- **実装方針**:
  - 固定タグリストを定義
  - マルチセレクトUIでタグ選択
  - タグでフィルタリング

**必要な機能**:

- タグ選択UI（Checkbox/Select）
- タグ表示（バッジ形式）
- タグフィルタ

---

#### 11. **全国TODO機能**

**現状との適合度：⭐⭐（新規実装が必要）**

- ❌ **既存**: なし
- 🎯 **要件**: 全国TODO一覧、県への移動/コピー
- **実装方針**:
  - アイテムとほぼ同じ構造だが、県が任意
  - 移動/コピー機能で県ボードへ遷移

**必要な機能**:

- 全国TODO一覧画面
- 移動/コピーUI（モーダル）
- 県選択UI（マップ活用可能）

---

#### 12. **履歴管理機能**

**現状との適合度：⭐⭐（新規実装が必要）**

- ❌ **既存**: なし
- 🎯 **要件**: 履歴作成、一覧、ギャラリー表示、評価/感想/値段等
- **実装方針**:
  - 履歴はアイテムに紐づく（1対多）
  - ギャラリーはサムネ中心のグリッド表示

**必要な機能**:

- 履歴作成フォーム
- 履歴一覧表示
- ギャラリービュー
- 評価入力UI（星評価等）

---

## 📊 実装優先度マトリクス

### Phase 1: MVP基盤（既存活用 + 最小実装）

1. ✅ 都道府県マップ・データ（既存）
2. 🔨 ルーティング拡張（React Router活用）
3. 🔨 データ型定義（Prefecture拡張 + 新規型）
4. 🔨 グループ管理（最小限：作成/参加）
5. 🔨 アイテム管理（CRUD）
6. 🔨 ステータス管理（行った/行ってない）

### Phase 2: コア機能

7. 🔨 メディア埋め込み（Instagram 3段階表示）
8. 🔨 検索・フィルタ
9. 🔨 タグ機能
10. 🔨 履歴管理（基本）

### Phase 3: 拡張機能

11. 🔨 全国TODO
12. 🔨 履歴ギャラリー
13. 🔨 また行きたい機能
14. 🔨 編集衝突検知

---

## 🎨 UI/UX設計の活用ポイント

### 既存のマップを活用できる場面

1. **グループホーム画面**
   - マップ表示 + 各県の件数表示
   - マップクリックで県ボードへ遷移

2. **アイテム登録時の県選択**
   - マップから選択（視覚的）
   - ドロップダウンも併用

3. **全国TODO → 県への移動**
   - マップで移動先の県を選択

### 既存のスタイリングを活用

- Tailwind CSSの設定をそのまま使用
- レスポンシブ対応の考え方を統一

---

## ⚠️ 注意点・検討事項

### データ構造の拡張

- 市データの追加が必要（都道府県データに含めるか別ファイルか）
- 既存の`Prefecture`型を拡張するか、別型を作るか

### バックエンドAPI

- 現在はAPIクライアント設定のみ
- バックエンドAPIの実装が必要
- Orvalで型定義を自動生成する前提

### 状態管理

- TanStack Queryでサーバー状態管理
- ローカル状態はReact state/Context
- グループ選択はContextで管理（MVP）

### セキュリティ

- 招待リンクのトークン生成（ランダム、長い）
- 埋め込みHTMLのXSS対策（sanitize）
- グループ外アクセス制御

---

## 📝 次のステップ（実装時）

1. **データ型定義の拡張**
   - `Prefecture`型に`cities`追加
   - 新規型定義ファイル作成

2. **ルーティング設計**
   - 画面構成に合わせてルート定義
   - ナビゲーションコンポーネント作成

3. **API設計**
   - OpenAPI仕様書作成
   - Orvalで型定義生成

4. **コンポーネント設計**
   - 共通コンポーネント（Card, Modal等）
   - 画面コンポーネント（県ボード、アイテム詳細等）
